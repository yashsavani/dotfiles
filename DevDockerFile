# Use CUDA-enabled base image from NVIDIA
FROM nvidia/cuda:12.2.0-devel-ubuntu20.04

# Locale setup and installation of essential packages
RUN apt-get update && \
    apt-get install -y locales && \
    locale-gen en_US.UTF-8 && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        sudo wget curl git build-essential software-properties-common && \
    add-apt-repository -y ppa:neovim-ppa/unstable && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y neovim && \
    apt-get autoremove && \
    apt-get autoclean
# Set environment language to US English
ENV LANG en_US.UTF-8

# Add a new user and grant sudo privileges
RUN useradd -m user && \
    echo "user:pass" | chpasswd && \
    adduser user sudo && \
    echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Switch to the new user
USER user

# Set working directory to the user's home
WORKDIR /home/user

# Install Mambaforge for package management
RUN wget https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh -O mambaforge.sh && \
    /bin/sh mambaforge.sh -b -p /home/user/opt/conda && \
    rm mambaforge.sh

# Clone config files from GitHub repository
ENV ENV_TYPE=docker
RUN git clone --depth 1 -b linux_x86_64 https://github.com/yashsavani/dotfiles.git /home/user/.config
RUN ln -s /home/user/.config/zshrc /home/user/.zshrc

# Initialize conda/mamba
RUN echo 'eval "$(/home/user/opt/conda/bin/conda shell.zsh hook)"' >> ~/.zshrc
ENV PATH=/home/user/opt/conda/bin:$PATH

# Install necessary packages via mamba
RUN mamba update -y conda mamba
RUN mamba install -y \
        zsh kitty gcc gxx_linux-64 git git-lfs make cmake nodejs \
        lazygit exa bat bpytop fd sd ripgrep \
        jupyter neovim python-lsp-server black \
        flake8 ipython ipdb

# Install zsh plugin manager (Antigen)
RUN curl -L git.io/antigen > antigen.zsh

# Source zshrc to install zsh plugins
SHELL ["opt/conda/bin/zsh", "-c"]
RUN source /home/user/.zshrc

# Install Packer for neovim
RUN git clone --depth 1 https://github.com/wbthomason/packer.nvim \
    /home/user/.local/share/nvim/site/pack/packer/start/packer.nvim
RUN nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

# Default command to run zsh
CMD [ "opt/conda/bin/zsh" ]

